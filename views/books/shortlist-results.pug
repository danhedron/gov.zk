//- vim:ft=jade
extends ../skeleton
block title
  title Shortlist Results
block breadcrumb
  li
    a(href='/book-club') Book club
  li
    a(href='/book-club/short-list') Short list
block content
  - electorCount = Object.keys(electorate).length
  - max = books.length * electorCount
  - unanimousBooks = 0
  .grid-row
    .column-full
      h1.heading-xlarge Short list results
  .grid-row
    .column-two-thirds
      table
        thead
          tr
            th(colspan="3") Flags
            th Candidate
            th.numeric Approvals
            th.numeric
              abbr(title="Satisifaction Approval Voting") SAV
        if results.length == 0
          tr
            td(colspan="7",style="text-align:center") Awaiting first ballotâ€¦
        for result in results
          tr
            if result.readingList
              td(colspan="3").center.green Selected #{result.readingList}
            else
              td
                if result.longlistedBy === req.user
                  abbr.green(title="You nominated this")  &#9998;
              td
                if result.difficult
                  abbr.red(title="Marked difficult") &#9936;
              td
                if result.alreadyRead && result.alreadyRead.length > 0
                  abbr.read(title="Someone has already read this") ðŸ“– 
            td
              strong
                a(href='/book-club/book/' + result.isbn) #{result.title}
              br
              span  #{result.author}

            if result.approve.length == 0
              td.numeric â€”
              td.numeric â€”
            else
              if result.approve.length === electorCount
                - unanimousBooks++
                td.numeric(title="Unanimous approval by entire electorate").unanimous #{result.approve.length}
              else
                if result.approve.length > 0 && result.disapprove.length === 0
                  td.numeric(title="No dissents").almost-unanimous #{result.approve.length}
                else
                  td.numeric(title=result.approve.join(', ')) #{result.approve.length}
              - sav = (result.scaledSav/100*Object.keys(electorate).length).toFixed(2)
              td.numeric #{sav}
    .column-one-third
      table
        thead
          tr
            th Elector
            th.numeric Votes
            th.numeric
              abbr(title="Approvals") Appr.
        - sum = 0
        for elector in Object.keys(electorate)
          - sum += electorate[elector].total
          tr
            td #{elector}
            if electorate[elector].total == 0
              td.numeric Nil
            else
              if electorate[elector].total == books.length
                td.numeric Complete
              else if electorate[elector].total > books.length
                td.numeric.red #{electorate[elector].total} of #{books.length}
              else
                td.numeric #{electorate[elector].total} of #{books.length}
            td.numeric(title=electorate[elector].approve+' approvals') #{Math.round((electorate[elector].approve/electorate[elector].total)*100)}%

      p #{sum} of #{max} votes returned.
      p
        .data
          span.data-item.bold-xlarge #{unanimousBooks}
          span.data-item.bold-xsmall unanimous books
      p.
        The shortlist is created using the <a href="//en.wikipedia.org/wiki/Approval_voting">Approval Voting</a>
        electoral system.

        It is a simple way to vote on a large number of candidates without having to rank them
        individually.

        The winner is the candidate with the most number of approvals (yes votes).
      hr
      p.
        For comparison, the results of <a href="//en.wikipedia.org/wiki/Satisfaction_approval_voting">satisfaction approval voting</a>
        are also provided.

        This is similar to approval voting, except that each elector has one vote shared between all
        their approvals, so each approval from a voter that votes five times is worth one fifth; and
        a voter who votes ten times has their approval worth one tenth.
      p.
        This has the effect of looking at how "satisfied" a voter is with an outcome: it tends to
        return more diverse candidates than vanilla approval voting (which is usually only used for
        single-winner elections).

      p.
        SAV ususally results in an unwieldy irrational number, so the results displayed have been scaled
        to be a value between 0 and #{Object.keys(electorate).length}.
      hr
      if state.allowVoting
        if sum !== max
            p.
              Votes shown are provisional, as not everybody who has submitted a book to the longlist, or
              begun voting on the shortlist, has completed their ballots.
        else
          p.
            Everybody that has submitted a book to the longlist, or begun voting on the shortlist, has
            completed their ballots.
      else
        p Polls are closed.
  .grid-row
     .column-full
